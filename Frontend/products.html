<!DOCTYPE html>
<html lang="vi">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>E-Shop | Sản phẩm</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="/Frontend/assets/css/styles.css" rel="stylesheet">
</head>
<body>
	<div id="navbar"></div>
	<div class="container">
		<h2 class="mb-3">Sản phẩm</h2>
		<div class="row g-2 mb-3">
			<div class="col-md-6">
				<div class="input-group">
					<input id="q" class="form-control" placeholder="Tìm kiếm..."/>
					<button class="btn btn-primary" id="btnSearch">Tìm</button>
				</div>
			</div>
			<div class="col-md-4">
				<select id="cat" class="form-select"><option value="">Tất cả danh mục</option></select>
			</div>
			<div class="col-md-2 text-end">
				<div class="btn-group" role="group">
					<button class="btn btn-outline-secondary btn-sm" id="prev">«</button>
					<button class="btn btn-outline-secondary btn-sm" id="next">»</button>
				</div>
			</div>
		</div>
		<div class="row" id="list"></div>
	</div>

	<script>window.USE_HTTP = true;</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script type="module">
		async function loadPartial(id, url){ const html = await (await fetch(url)).text(); document.getElementById(id).innerHTML = html; }
		await loadPartial('navbar','/Frontend/partials/navbar.html');
		import { ProductAPI, CartAPI } from '/Frontend/assets/js/api.js';
		const listEl = document.getElementById('list');
		let page = 1, pageSize = 9, cache = [];
		async function loadAll(){
			const q = document.getElementById('q').value.trim();
			const cid = document.getElementById('cat').value || '';
			cache = await ProductAPI.list(q);
			if (cid) cache = cache.filter(x => x.categoryId && x.categoryId.toLowerCase() === cid.toLowerCase());
			page = 1; renderPage();
		}
		function renderPage(){
			listEl.innerHTML = '';
			const start = (page-1)*pageSize; const items = cache.slice(start, start+pageSize);
			items.forEach(p=>{
				const col = document.createElement('div'); col.className = 'col-12 col-md-4 mb-3';
				const v = (p.variants && p.variants.length>0) ? p.variants[0] : null;
				col.innerHTML = `
					<div class="product-card">
						${p.mainImageUrl ? `<img src="${p.mainImageUrl}" alt="${p.name}"/>` : ''}
						<h6 class="mt-2">${p.name}</h6>
						<div class="d-flex gap-2">
							<a class="btn btn-sm btn-outline-primary" href="/Frontend/product.html?id=${p.id}">Chi tiết</a>
							<button class="btn btn-sm btn-primary">Thêm giỏ</button>
						</div>
					</div>`;
				listEl.appendChild(col);
				col.querySelector('button').onclick = async()=>{
					await CartAPI.add({ productId: p.id, productVariantId: v? v.id:null, quantity:1, unitPrice: v? (v.basePrice||0):0 });
					alert('Đã thêm vào giỏ');
				}
			});
		}
		document.getElementById('btnSearch').onclick = loadAll;
		document.getElementById('prev').onclick = ()=> { if (page>1){ page--; renderPage(); } };
		document.getElementById('next').onclick = ()=> { if ((page*pageSize) < cache.length){ page++; renderPage(); } };
		// load categories
		const cats = await ProductAPI.listCategories();
		const sel = document.getElementById('cat');
		cats.forEach(c=>{ const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.name; sel.appendChild(opt); });
		document.getElementById('cat').onchange = loadAll;
		loadAll();
	</script>
</body>
</html>

